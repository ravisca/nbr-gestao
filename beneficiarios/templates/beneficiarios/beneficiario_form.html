{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{{ titulo }} | NBR{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h4 class="mb-0">{{ titulo }}</h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <h5 class="text-primary mb-3">Dados Pessoais</h5>
                    <div class="row">
                        <div class="col-md-6">{{ form.nome_completo|as_crispy_field }}</div>
                        <div class="col-md-3">{{ form.data_nascimento|as_crispy_field }}</div>
                        <div class="col-md-3">{{ form.cpf|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.telefone|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.foto|as_crispy_field }}</div>
                    </div>

                    <!-- Dados do Responsável (Condicional < 18 anos) -->
                    <div id="responsavel-section" style="display:none;">
                        <h5 class="text-primary mt-4 mb-3">Dados do Responsável</h5>
                        <div class="row">
                            <div class="col-md-8">{{ form.responsavel|as_crispy_field }}</div>
                            <div class="col-md-4">{{ form.grau_parentesco|as_crispy_field }}</div>
                        </div>
                    </div>

                    <h5 class="text-primary mt-4 mb-3">Programa</h5>
                    <div class="row">
                        <div class="col-md-4">{{ form.projeto|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.atividade|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.turno|as_crispy_field }}</div>
                    </div>

                    <h5 class="text-primary mt-4 mb-3">Saúde e Acessibilidade</h5>
                    <div class="row">
                        <div class="col-md-3">{{ form.tem_problema_saude|as_crispy_field }}</div>
                        <div class="col-md-9">{{ form.descricao_saude|as_crispy_field }}</div>
                        <div class="col-md-3">{{ form.necessita_acessibilidade|as_crispy_field }}</div>
                        <div class="col-md-9">{{ form.descricao_acessibilidade|as_crispy_field }}</div>
                    </div>

                    <h5 class="text-primary mt-4 mb-3">Controle</h5>
                    <div class="row">
                        <div class="col-md-3">{{ form.status|as_crispy_field }}</div>
                        <div class="col-md-9">{{ form.observacoes|as_crispy_field }}</div>
                    </div>

                    <div class="d-flex justify-content-end gap-2 mt-4">
                        <a href="{% url 'beneficiarios_list' %}" class="btn btn-outline-secondary">Cancelar</a>
                        <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Salvar
                            Registro</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</form>
</div>
</div>
</div>
</div>

<script src="https://unpkg.com/imask"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- MÁSCARAS DE INPUT ---
        const cpfInput = document.getElementById('id_cpf');
        const telInput = document.getElementById('id_telefone');

        if (cpfInput) {
            IMask(cpfInput, { mask: '000.000.000-00' });
        }
        if (telInput) {
            IMask(telInput, { mask: '(00)00000-0000' });
        }

        // --- LÓGICA CONDICIONAL ---
        function toggleField(checkboxId, fieldId) {
            const checkbox = document.getElementById(checkboxId);
            // O campo 'fieldId' é o ID do input gerado pelo Django.
            // O Crispy Forms envolve o input em uma div com classe 'mb-3'.
            // Vamos esconder essa div pai para sumir com o label também.
            const input = document.getElementById(fieldId);
            const parentDiv = input ? input.closest('.mb-3') || input.parentNode : null;

            if (checkbox && parentDiv) {
                // Função interna para atualizar visibilidade
                const update = () => {
                    if (checkbox.checked) {
                        parentDiv.style.display = 'block';
                    } else {
                        parentDiv.style.display = 'none';
                        input.value = ''; // Limpa o valor ao esconder
                    }
                };

                // Executa agora e no evento change
                update();
                checkbox.addEventListener('change', update);
            }
        }

        toggleField('id_tem_problema_saude', 'id_descricao_saude');
        toggleField('id_necessita_acessibilidade', 'id_descricao_acessibilidade');

        // --- VISIBILIDADE DO RESPONSÁVEL (MENOR DE 18 ANOS) ---
        const dataNascInput = document.getElementById('id_data_nascimento');
        const responsavelSection = document.getElementById('responsavel-section');

        function checkAge() {
            if (!dataNascInput.value) return;

            const dob = new Date(dataNascInput.value);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            const m = today.getMonth() - dob.getMonth();

            if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                age--;
            }

            if (age < 18) {
                responsavelSection.style.display = 'block';
            } else {
                responsavelSection.style.display = 'none';
                // Limpa os campos se esconder
                document.getElementById('id_responsavel').value = '';
                document.getElementById('id_grau_parentesco').value = '';
            }
        }

        if (dataNascInput) {
            dataNascInput.addEventListener('change', checkAge);
            dataNascInput.addEventListener('blur', checkAge); // Garante update ao sair do campo
            checkAge(); // Check inicial (edição)
        }
    });
</script>
{% endblock %}